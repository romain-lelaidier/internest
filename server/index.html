<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>InterNest</title>
    <style>
        body { font-family: monospace; background: #1a1a2e; color: #e0e0e0; padding: 20px; }
        h1 { color: #00d4aa; }
        h2 { color: #7b8cde; margin-top: 24px; }
        .esp-block { background: #16213e; padding: 12px 16px; border-radius: 8px; margin: 8px 0; }
        .species { padding: 4px 0; }
        .confidence { color: #00d4aa; }
        .event { padding: 3px 0; font-size: 14px; }
        .arrivee { color: #4ade80; }
        .depart { color: #f87171; }
        .time { color: #888; }
        .empty { color: #666; font-style: italic; }

        .controls { background: #16213e; padding: 12px 16px; border-radius: 8px; margin: 12px 0; display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
        .controls label { font-size: 13px; }
        .controls input[type=range] { width: 160px; accent-color: #00d4aa; }
        .controls button { background: #7b8cde; color: #fff; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-family: monospace; font-size: 13px; }
        .controls button:hover { background: #5a6cb8; }
        .controls .val { color: #00d4aa; min-width: 36px; display: inline-block; }

        .event-header { display: flex; align-items: center; gap: 12px; }
        .event-header h2 { margin-bottom: 0; }
    </style>
</head>
<body>
    <h1>InterNest - Detection d'especes en temps reel.</h1>

    <div class="controls">
        <label>Seuil de confiance: <span class="val" id="conf-val">50%</span></label>
        <input type="range" id="conf-slider" min="5" max="95" step="5" value="50">
        <button onclick="exportCSV()">Exporter CSV</button>
        <button onclick="clearEvents()">Vider le journal</button>
    </div>

    <h2>Especes actives par ESP</h2>
    <div id="active"></div>

    <div class="event-header">
        <h2>Evenements recents</h2>
    </div>
    <div id="events"></div>

    <script>
    // --- Seuil de confiance ---
    const slider = document.getElementById('conf-slider');
    const confVal = document.getElementById('conf-val');
    let debounceTimer = null;

    slider.addEventListener('input', () => {
        confVal.innerText = slider.value + '%';
    });

    slider.addEventListener('change', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetch('/api/set_confidence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ value: slider.value / 100 })
            });
        }, 200);
    });

    // --- Clear / Export ---
    function clearEvents() {
        fetch('/api/clear_events', { method: 'POST' });
    }

    function exportCSV() {
        window.location.href = '/api/export_csv';
    }

    // --- Refresh ---
    function refresh() {
        fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                const now = data.now;

                // especes actives
                const activeDiv = document.getElementById('active');
                const macs = Object.keys(data.active);
                if (macs.length === 0) {
                    activeDiv.innerHTML = '<p class="empty">aucun ESP connecte</p>';
                } else {
                    activeDiv.innerHTML = macs.map(mac => {
                        const species = data.active[mac];
                        const names = Object.keys(species);
                        const inner = names.length === 0
                            ? '<div class="empty">aucune espece</div>'
                            : names.map(sp =>
                                `<div class="species">${sp} â€” <span class="confidence">${Math.round(species[sp].confidence * 100)}%</span></div>`
                              ).join('');
                        return `<div class="esp-block"><strong>${mac}</strong>${inner}</div>`;
                    }).join('');
                }

                // sync slider avec le serveur
                const serverConf = Math.round(data.confidence * 100);
                if (document.activeElement !== slider) {
                    slider.value = serverConf;
                    confVal.innerText = serverConf + '%';
                }

                // evenements
                const evDiv = document.getElementById('events');
                if (data.events.length === 0) {
                    evDiv.innerHTML = '<p class="empty">aucun evenement</p>';
                } else {
                    evDiv.innerHTML = data.events.map(ev => {
                        const ago = Math.round(now - ev.time);
                        const tag = ev.type === 'arrivee'
                            ? '<span class="arrivee">[ARRIVEE]</span>'
                            : '<span class="depart">[DEPART]</span>';
                        const conf = ev.type === 'arrivee' && ev.confidence != null
                            ? ` (<span class="confidence">${Math.round(ev.confidence * 100)}%</span>)`
                            : '';
                        return `<div class="event"><span class="time">${ago}s</span> ${tag} ${ev.species} sur <strong>${ev.mac}</strong>${conf}</div>`;
                    }).join('');
                }
            });
    }

    refresh();
    setInterval(refresh, 2000);
    </script>
</body>
</html>
